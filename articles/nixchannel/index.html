<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Creating a static nix channel</title>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<link rel="me" href="https://cv.lpenz.org" />
<link rel="me" href="https://twitter.com/lpenz" />
<link rel="me" href="https://www.linkedin.com/in/lpenz" />
<link rel="me" href="https://github.com/lpenz" />
<link rel="me" href="https://stackoverflow.com/cv/lpenz" />
<link rel="me" href="mailto:lpenz@lpenz.org" />
<meta name="author" content="Leandro Lisboa Penz"/>
<meta name="description" content="Avulsos by Penz"/>
<style>
html { /* get footer on bottom: */
    position: relative;
    min-height: 100%;
}
body {
    margin-bottom: 30px; /* Margin bottom by footer height */
}
.footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 30px; /* Set the fixed height of the footer here */
    line-height: 30px; /* Vertically center the text there */
    /* background-color: #f5f5f5; */
}
nav.navbar {
    margin-bottom: 2em; /* space between navbar and contents */
}
pre {
    background-color: #f1f1f1;
    border-left: 4px solid #d9d9d9;
    padding: 15px;
}
#title {
    text-align: center;
    margin-bottom: 1em;
    font-size: 2.5rem;
}
h1, h2, h3, h4, h5, h6 { margin-top: 1em; margin-bottom: 1em; }
h1 { font-size: 1.6rem; }
h2 { font-size: 1.4rem; }
h3, h4, h5, h6 { font-size: 1.2rem; }
td > ul { margin-bottom: 0px; }
em {
    color: indigo;
}
div#main {
    padding-bottom: 1em;
}
div.center > img { margin: 0 auto; } /* center images by default */
div#toc {
    background: #f9f9f9 none repeat scroll 0 0;
    border: 1px solid #aaa;
    display: table;
}
div#toc .toctitle {
    font-weight: 700;
    text-align: center;
    margin-top: 1em;
}
div#toc ul {
    padding-right: 1em;
}
div#toc li, div#toc ul, div#toc ul li {
    list-style: outside none none !important;
}
</style>
<link rel="alternate" type="application/rss+xml" title="Whatsnew feed of Avulsos by Penz" href="http://feeds.feedburner.com/lpenz/avulsos/whatsnew.xml"/>
<link rel="alternate" type="application/rss+xml" title="Articles feed of Avulsos by Penz" href="http://feeds.feedburner.com/lpenz/avulsos/articles.xml"/>
<link rel="icon" type="image/png" href="../../media/logo-black.png" />
<meta name="p:domain_verify" content="629162357f7580ddc473183d74c50ef8"/>
<meta name="generator" content="http://txt2tags.sf.net" />

</head>

<body>


<nav class="navbar navbar-expand-md navbar-dark bg-dark">
    <div class="container">
    <a class="navbar-brand" href="../../index.html"><img alt="Avulsos by Penz" src="../../media/logo-white.png" width="20" height="20" class="d-inline-block align-middle" />&nbsp;&nbsp;&nbsp;Avulsos by Penz</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse auto" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto">
		<li
		class="nav-item"
		><a class="nav-link" href="../../index.html">Home</a></li>
		<li
		class="nav-item active"
		><a class="nav-link" href="../../articles/index.html">Articles</a></li>
		<li
		class="nav-item"
		><a class="nav-link" href="../../debian/index.html">Debian</a></li>
		<li
		class="nav-item"
		><a class="nav-link" href="../../about/index.html">About</a></li>
    </div>
    </div>
</nav>

<div class="container" id="main">

<h1 id="title">Creating a static nix channel</h1>


<div class="body" id="body">
<p>
TL;DR: full example at <a href="https://github.com/lpenz/nixpkgs-lpenz/">https://github.com/lpenz/nixpkgs-lpenz/</a>
</p>
<p>
<a href="https://nixos.org">Nix</a> is a packet manager for Unix-like systems that
can be effectively used as an overlay distribution.
</p>
<p>
These are my notes on how to create a static nix channel with a binary
cache that can be used to distribute compiled packages - and how to do
it using <a href="https://travis-ci.com">travis-ci</a> and
<a href="https://pages.github.com/">github pages</a>. This assumes that we already
have the derivations that we want to distribute.
</p>
<p>
You should also check out <a href="https://cachix.org/">Cachix</a>, as an
alternative to what is described here.
</p>

<section>
<h1>Generating key pair</h1>

<p>
The first step in creating a repository is generating a key pair:
</p>

<pre>
nix-store --generate-binary-cache-key lpenz.org cache-priv-key.pem cache-pub-key.pem
</pre>

<p>
That creates the single-line files <code>cache-priv-key.pem</code> and
<code>cache-pub-key.pem</code>. The first has the private key, which we will
use to do the packaging process in travis-ci (store it in a safe
place). The second file has the public key that we will use to
authenticate the packages in the clients.
</p>

</section>
<section>
<h1>Setting up the repository in github and travis-ci</h1>

<p>
This article is not going into the details of how to create a repository and populate it with nix derivations. Here are some references on that:
</p>

<ul>
<li><a href="https://nixos.org/nixos/nix-pills/generic-builders.html">https://nixos.org/nixos/nix-pills/generic-builders.html</a>
</li>
<li><a href="https://nixos.org/nixpkgs/manual/#chap-stdenv">https://nixos.org/nixpkgs/manual/#chap-stdenv</a>
</li>
</ul>

<p>
To set up github pages, go to the <em>Settings</em> page of the github
repsitory with the derivations, <em>GitHub Pages</em> and set <em>Source</em> to
the <em>gh-pages branch</em>.
</p>
<p>
To set up travis-ci, create a <em>NIX_CACHE_PRIV_KEY</em> environment variable in
the settings
(<a href="https://docs.travis-ci.com/user/environment-variables/">details</a>),
with the contents of <code>cache-priv-key.pem</code>. Keep in mind the best
practices at
<a href="https://docs.travis-ci.com/user/best-practices-security#recommendations-on-how-to-avoid-leaking-secrets-to-build-logs">Recommendations on how to avoid leaking secrets to build logs</a>
to avoid problems.
</p>

<section>
<h2>Creating the channel</h2>

<p>
A channel is simply a <code>nixexprs.tar.xz</code> with all nix derivation
files, and a <code>binary-cache-url</code> file that, as the name implies,
points to the binary cache URL.
</p>
<p>
Let's assume that we are creating the channel in the <code>_output</code>
directory, and that we will put the cache files in
<code>_output/cache</code>. To create the <code>nixexprs.tar.xz</code> file:
</p>

<pre>
tar -cJf _output/nixexprs.tar.xz ./*.nix \
    --transform "s,^,${PWD##*/}/," \
    --owner=0 --group=0 --mtime="1970-01-01 00:00:00 UTC"
</pre>

<p>
Creating the <code>binary-cache-url</code> file is simpler:
</p>

<pre>
echo '&lt;URL of cache&gt;' &gt; _output/binary-cache-url
</pre>

<p>
Nix also tries to retrieve the channel URL by itself - create a
<code>index.html</code> file to handle that:
</p>

<pre>
touch _output/index.html
</pre>

</section>
<section>
<h2>Creating the binary cache</h2>

<p>
To create the binary cache, start by building the packages with:
</p>

<pre>
nix-build
</pre>

<p>
Then sign the results:
</p>

<pre>
export NIX_SECRET_KEY_FILE="$PWD/nix-cache-priv-key.pem"
echo "$NIX_CACHE_PRIV_KEY" &gt; "$NIX_SECRET_KEY_FILE"
nix store sign -k "$NIX_SECRET_KEY_FILE"
</pre>

<p>
And finally, copy the results from the store to the cache directory:
</p>

<pre>
nix copy --to "file:///$PWD/_output/cache"
</pre>

</section>
<section>
<h2>.travis.yml deploy section</h2>

<p>
Detailed instructions on how to set this up are at
<a href="https://docs.travis-ci.com/user/deployment/pages/">GitHub Pages Deployment</a>.
We essentially have to set up a GITHUB_TOKEN.
</p>
<p>
The deploy section of <code>.travis.yml</code> ends up looking like the following:
</p>

<pre>
deploy:
  provider: pages
  skip-cleanup: true
  github-token: "$GITHUB_TOKEN"
  local_dir: _output
  target-branch: gh-pages
  on:
    branch: master
</pre>

</section>
</section>
<section>
<h1>Using the channel</h1>

<p>
To use the channel, add the channel URL to nix:
</p>

<pre>
nix-channel --add &lt;URL of channel&gt;
nix-channel --update
</pre>

<p>
That allows us to build packages from the channel, but it doesn't
make nix use the binary cache. To enable the cache, we have to set up
the channel as a <em>substituter</em>. To do that, put the following in
<code>~/.config/nix/nix.conf</code>, creating the file it if it doesn't exist:
</p>

<pre>
substituters = https://cache.nixos.org &lt;URL of cache&gt;
trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= &lt;cache-pub-key.pem contents&gt;
</pre>

<p>
Note that we have to also add the default, as that line is an absolute
configuration.
</p>

</section>
<section>
<h1>Conclusions</h1>

<p>
Nix is very versatile, and one way to use it is an overlay
distribution, by installing <a href="https://github.com/NixOS/nixpkgs">nixpkgs</a>
over an existing non-NixOS linux installation. On that setup, a
private nix channel can be very useful to develop and deploy software
consistently without being pegged to a particular gloal distribution
or environment - and the binary cache allows us to do that without
even having to recompile from source. That's how I've been using it,
and I'm quite happy with the results.
</p>
</section>
</div>


</div><!--container-->

<div class="footer bg-dark text-light">
	<div class="container">
		<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/"><img alt="Creative Commons License" style="border-width:0; vertical-align:middle;" src="https://licensebuttons.net/l/by-sa/3.0/80x15.png" /></a>
		This work by <a href="mailto:lpenz@lpenz.org">Leandro Lisboa Penz</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
	</div>
</div>

<!-- Other invisible stuff and javascripts: -->

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>


</body>

</html>
<!-- vim: ft=html
-->

